<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Diary Analyzer - Beautiful Calendar Analytics</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Beautiful time series visualization for your Google Calendar diary entries. Track productivity, analyze patterns, and gain insights into how you spend your time.">
    <meta name="keywords" content="calendar analytics, time tracking, productivity, Google Calendar, data visualization, diary analyzer">
    <meta name="author" content="Diary Analyzer">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Diary Analyzer - Beautiful Calendar Analytics">
    <meta property="og:description" content="Beautiful time series visualization for your Google Calendar diary entries. Track productivity and gain insights.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://diary-analyzer.vercel.app">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Diary Analyzer - Beautiful Calendar Analytics">
    <meta name="twitter:description" content="Beautiful time series visualization for your Google Calendar diary entries.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="icons/icon16.svg">
    <link rel="apple-touch-icon" href="icons/icon48.svg">
    
    <!-- PWA Manifest for standalone app experience -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS PWA Meta Tags for standalone mode (no URL bar) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Diary Analyzer">
    
    <!-- Android PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    
    <!-- Disable phone number detection -->
    <meta name="format-detection" content="telephone=no">
    
    <!-- Full screen mode -->
    <meta name="full-screen" content="yes">
    <meta name="browsermode" content="application">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="styles.css" as="style">
    <link rel="preload" href="https://accounts.google.com/gsi/client" as="script">
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Load Google API Client Library for proper OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <h1>üìä Diary Analyzer</h1>
                <p class="header-subtitle">Beautiful time series visualization for your Google Calendar diary entries</p>
                <div class="controls">
                    <button id="refreshBtn" class="refresh-btn">üîÑ Refresh</button>
                    <button id="signOutBtn" class="signout-btn hidden">üö™ Sign Out</button>
                </div>
            </div>
        </header>

        <main class="app-main">
            <!-- Auth Section -->
            <section id="authSection" class="auth-section">
                <div class="auth-card">
                    <h2>üìä Welcome to Diary Analyzer</h2>
                    <p>Sign in with your Google account to view and analyze your calendar diary entries</p>
                    
                    <!-- Custom Sign-In Button with OAuth Token Request -->
                    <div id="buttonDiv"></div>
                    
                    <p class="auth-note">We only request read-only access to your calendar data</p>
                </div>
            </section>

            <!-- Loading Section -->
            <section id="loadingSection" class="loading-section hidden">
                <div class="loading-spinner"></div>
                <p id="loadingMessage">Loading your calendar data...</p>
                <p id="loadingDetails" style="font-size: 0.85rem; color: #888; margin-top: 0.5rem;"></p>
                <button id="cancelAuthBtn" onclick="cancelAuthAndShowSignIn()" style="
                    margin-top: 1.5rem;
                    padding: 0.5rem 1rem;
                    background: transparent;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    color: #666;
                    cursor: pointer;
                    font-size: 0.85rem;
                ">Cancel and try again</button>
            </section>

            <!-- Error Section -->
            <section id="errorSection" class="error-section hidden">
                <div class="error-card">
                    <h2>‚ö†Ô∏è Something went wrong</h2>
                    <p id="errorMessage"></p>
                    <button id="retryBtn" class="retry-btn">Try Again</button>
                </div>
            </section>

            <!-- Content Section -->
            <section id="contentSection" class="content-section">
                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button id="highlightsTab" class="tab-btn active">‚≠ê Highlights & Milestones</button>
                    <button id="analyticsTab" class="tab-btn">üìä Analytics</button>
                </div>
                
                <!-- Highlights Tab Content -->
                <div id="highlightsTabContent" class="tab-content active">
                <!-- Main Calendar View -->
                <div class="main-calendar-view">
                    <div class="calendar-header">
                        <h2>‚≠ê Highlights & Milestones Calendar</h2>
                        <div class="calendar-controls">
                            <button id="prevYear" class="calendar-nav-btn">‚Üê Previous Year</button>
                            <span id="currentYear" class="current-year">2024</span>
                            <button id="nextYear" class="calendar-nav-btn">Next Year ‚Üí</button>
                        </div>
                        <button id="highlightsLogButton" class="log-btn">üìù Log Highlight</button>
                    </div>
                    <div class="calendar-wrapper">
                        <div id="calendarGrid" class="calendar-grid">
                            <!-- Calendar will be dynamically generated here -->
                        </div>
                    </div>
                </div>
                </div> <!-- End Highlights Tab Content -->
                
                <!-- Analytics Tab Content -->
                <div id="analyticsTabContent" class="tab-content">
                    <!-- Analytics Controls -->
                    <div class="analytics-controls">
                        <select id="dateRange" class="date-selector">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                        </select>
                        <select id="viewMode" class="view-selector">
                            <option value="distribution">Distribution</option>
                            <option value="timeline">Timeline</option>
                            <option value="advanced">Advanced Analytics</option>
                            <option value="aggregated">Category Trends</option>
                        </select>
                        <button id="logButton" class="log-btn">üìù Quick Log</button>
                        <button id="randomRecapBtn" class="random-recap-btn">üé≤ Random Recap</button>
                    </div>
                    
                    <div class="stats-container">
                    <div class="stat-card">
                        <h3>Total Events</h3>
                        <p id="totalEvents" class="stat-value">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Active Hours</h3>
                        <p id="activeHours" class="stat-value">0h 0m</p>
                    </div>
                    <div class="stat-card">
                        <h3>Most Common</h3>
                        <p id="mostCommon" class="stat-value">-</p>
                </div>
            </div>

                <!-- Navigation -->
                <div class="date-navigation">
                    <button id="prevDay" class="nav-btn">‚Üê Prev</button>
                    <span id="currentDate" class="current-date">Today</span>
                    <button id="nextDay" class="nav-btn">Next ‚Üí</button>
                </div>

                <!-- Timeline View -->
                <div id="timelineContainer" class="timeline-container hidden">
                    <h3>Timeline</h3>
                    <div id="timeline" class="timeline"></div>
                </div>

                <!-- Distribution View -->
                <div id="distributionContainer" class="distribution-container">
                    <h3>Time Distribution</h3>
                    <p class="distribution-subtitle">Daily time distribution by calendar</p>
                    <div id="distributionChart" class="distribution-chart"></div>
                    <div id="distributionStats" class="distribution-stats"></div>
                </div>

                <!-- Advanced Analytics View -->
                <div id="advancedContainer" class="advanced-container hidden">
                    <h3>Advanced Analytics</h3>
                    <div id="advancedCharts" class="advanced-charts">
                        <!-- Charts will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Aggregated Category Trends View -->
                <div id="aggregatedContainer" class="aggregated-container hidden">
                    <h3>Category Trends</h3>
                    <div class="aggregated-controls">
                        <div class="control-group">
                            <label for="aggregationPeriod">Aggregation Period:</label>
                            <select id="aggregationPeriod" class="period-selector">
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="showEventCount">Show Event Count:</label>
                            <input type="checkbox" id="showEventCount" class="event-count-toggle">
                        </div>
                        <div class="control-group">
                            <button id="refreshCategoryTrends" class="refresh-category-btn">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div id="aggregatedChart" class="aggregated-chart">
                        <!-- Chart will be dynamically inserted here -->
                    </div>
                </div>
                </div> <!-- End Analytics Tab Content -->
            </section>
        </main>
        
        <!-- Day Details Popup Modal -->
        <div id="dayDetailsModal" class="day-details-modal hidden">
            <div class="day-details-modal-content">
                <div class="day-details-header">
                    <h2 id="dayDetailsTitle">Day Details</h2>
                    <button class="day-details-close" onclick="closeDayDetailsModal()">&times;</button>
                </div>
                <div class="day-details-content">
                    <div id="dayDetailsDate" class="day-details-date"></div>
                    <div id="dayDetailsEvents" class="day-details-events">
                        <!-- Calendar events will be shown here -->
                    </div>
                    <div id="dayDetailsHighlights" class="day-details-highlights">
                        <!-- Highlights and milestones will be shown here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Random Recap Popup Modal -->
        <div id="randomRecapModal" class="random-recap-modal hidden">
            <div class="random-recap-modal-content">
                <div class="random-recap-header">
                    <h2>üé≤ Random Recap</h2>
                    <button class="random-recap-close" onclick="closeRandomRecapModal()">&times;</button>
                </div>
                
                <div class="random-recap-settings">
                    <h3>Settings</h3>
                    <div class="random-recap-form-group">
                        <label for="lookbackPeriod">Lookback Period:</label>
                        <select id="lookbackPeriod" class="random-recap-lookback-select">
                            <option value="7">1 Week</option>
                            <option value="30">1 Month</option>
                            <option value="90">3 Months</option>
                            <option value="180">6 Months</option>
                            <option value="365" selected>1 Year</option>
                            <option value="730">2 Years</option>
                        </select>
                        <button id="generateRandomRecap" class="random-recap-generate-btn">üé≤ Generate Random Day</button>
                    </div>
                </div>
                
                <div class="random-recap-content">
                    <div class="random-recap-loading hidden">
                        <div class="random-recap-loading-spinner"></div>
                        <p>Finding a random day with activities...</p>
                    </div>
                    <div id="randomRecapResults"></div>
                </div>
            </div>
        </div>

        <!-- Log Highlight Popup Modal -->
        <div id="logModal" class="log-modal hidden">
            <div class="log-modal-content">
                <div class="log-modal-header">
                    <h2>üìù Log Highlight or Milestone</h2>
                    <button class="log-modal-close" onclick="closeHighlightModal()">&times;</button>
                </div>
                
                <div class="log-modal-body">
                    <form id="logForm" class="log-form">
                        <div class="form-group">
                            <label for="highlightDate">Date:</label>
                            <input type="date" id="highlightDate" name="highlightDate" class="date-input" required>
                        </div>
                        <div class="form-group">
                            <label for="highlightTitle">Title:</label>
                            <input type="text" id="highlightTitle" name="highlightTitle" class="title-input" placeholder="Enter highlight or milestone title" required>
                        </div>
                        <div class="form-group">
                            <label for="highlightDescription">Description:</label>
                            <textarea id="highlightDescription" name="highlightDescription" class="description-input" placeholder="Enter description (optional)"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="highlightType">Type:</label>
                            <select id="highlightType" name="highlightType" class="type-select" required>
                                <option value="highlight">Highlight</option>
                                <option value="milestone">Milestone</option>
                                <option value="achievement">Achievement</option>
                                <option value="memory">Memory</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="cancel-btn" onclick="closeHighlightModal()">Cancel</button>
                            <button type="submit" id="saveHighlight" class="save-highlight-btn">üíæ Save Highlight</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <footer class="app-footer">
            ¬© 2024 Diary Analyzer. Made with ‚ù§Ô∏è for productivity enthusiasts.
        </footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- config.js must load BEFORE app.js, so no defer -->
    <script src="config.js"></script>
    
    <!-- Google OAuth Setup - Client-Side Token Flow with Silent Refresh -->
    <script>
        // ============================================
        // CLIENT-SIDE OAUTH WITH SILENT TOKEN REFRESH
        // ============================================
        // 
        // How this works:
        // 1. Access tokens are stored locally with expiration time
        // 2. When token expires, we attempt "silent refresh" via Google
        // 3. Silent refresh works if user is still logged into Google
        // 4. If silent refresh fails, user clicks sign-in (just account picker, no password)
        //
        
        let tokenClient = null;
        let tokenRefreshTimer = null;
        
        // Helper function to update loading message
        function updateLoadingMessage(mainMessage, details = '') {
            const loadingMsg = document.getElementById('loadingMessage');
            const loadingDetails = document.getElementById('loadingDetails');
            if (loadingMsg) loadingMsg.textContent = mainMessage;
            if (loadingDetails) loadingDetails.textContent = details;
            const timestamp = new Date().toLocaleTimeString();
            console.log(`üì¢ [${timestamp}]`, mainMessage, details ? `(${details})` : '');
        }
        
        // Enhanced status tracking for debugging
        let authStatusLog = [];
        function logAuthStatus(status, details = '') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { timestamp, status, details };
            authStatusLog.push(entry);
            console.log(`üîê [${timestamp}] AUTH: ${status}`, details ? `- ${details}` : '');
            
            // Keep only last 20 entries
            if (authStatusLog.length > 20) {
                authStatusLog.shift();
            }
            
            // Update loading details with status
            const loadingDetails = document.getElementById('loadingDetails');
            if (loadingDetails) {
                loadingDetails.textContent = `${status}${details ? ': ' + details : ''}`;
            }
        }
        
        // Show auth debug info in error state
        function showAuthDebugInfo(message) {
            const errorMsgEl = document.getElementById('errorMessage');
            if (errorMsgEl) {
                const debugLog = authStatusLog.map(e => `[${e.timestamp}] ${e.status}: ${e.details}`).join('\n');
                errorMsgEl.innerHTML = `
                    <p>${message}</p>
                    <details style="margin-top: 1rem; text-align: left;">
                        <summary style="cursor: pointer; color: #666;">üîç Debug Info (click to expand)</summary>
                        <pre style="font-size: 0.75rem; background: #f5f5f5; padding: 0.5rem; border-radius: 4px; overflow-x: auto; white-space: pre-wrap;">${debugLog || 'No debug info available'}</pre>
                    </details>
                `;
            }
        }
        
        // ============================================
        // TOKEN STORAGE
        // ============================================
        
        function storeToken(accessToken, expiresIn) {
            const expiresAt = Date.now() + (expiresIn * 1000);
            const tokenData = {
                token: accessToken,
                expiresAt: expiresAt,
                storedAt: Date.now()
            };
            localStorage.setItem('diaryAnalyzerToken', JSON.stringify(tokenData));
            logAuthStatus('Token stored', `Expires: ${new Date(expiresAt).toLocaleString()} (in ${Math.round(expiresIn/60)}min)`);
            
            // Schedule proactive refresh
            scheduleTokenRefresh(expiresIn);
            
            return tokenData;
        }
        
        function getStoredToken() {
            try {
                const data = localStorage.getItem('diaryAnalyzerToken');
                if (data) {
                    return JSON.parse(data);
                }
            } catch (e) {
                console.error('Error reading stored token:', e);
            }
            return null;
        }
        
        function clearStoredToken() {
            localStorage.removeItem('diaryAnalyzerToken');
            localStorage.removeItem('googleToken'); // Legacy
            localStorage.removeItem('googleTokenData'); // Legacy
            window.accessToken = null;
            window.globalAccessToken = null;
            logAuthStatus('Token cleared', 'All stored tokens removed');
        }
        
        function isTokenValid() {
            const tokenData = getStoredToken();
            if (!tokenData || !tokenData.expiresAt) return false;
            // Valid if more than 5 minutes remaining
            return Date.now() < (tokenData.expiresAt - 5 * 60 * 1000);
        }
        
        function isTokenExpired() {
            const tokenData = getStoredToken();
            if (!tokenData || !tokenData.expiresAt) return true;
            return Date.now() > tokenData.expiresAt;
        }
        
        // ============================================
        // TOKEN REFRESH
        // ============================================
        
        function scheduleTokenRefresh(expiresIn) {
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
            }
            
            // Refresh 5 minutes before expiration
            const refreshIn = Math.max((expiresIn - 300) * 1000, 60000);
            console.log('‚è∞ Token refresh scheduled in', Math.round(refreshIn / 60000), 'minutes');
            
            tokenRefreshTimer = setTimeout(() => {
                console.log('üîÑ Proactive token refresh triggered');
                silentTokenRefresh();
            }, refreshIn);
        }
        
        function silentTokenRefresh(onSuccess, onFailure) {
            logAuthStatus('Silent refresh started', 'Attempting to refresh token without popup');
            
            if (!tokenClient) {
                logAuthStatus('Silent refresh failed', 'Token client not initialized');
                if (onFailure) onFailure(new Error('Token client not initialized'));
                return;
            }
            
            // Store callbacks
            window._refreshCallbacks = { onSuccess, onFailure };
            window._isRefreshAttempt = true;
            
            // Set a timeout - silent refresh should complete quickly
            const REFRESH_TIMEOUT = 15000; // 15 seconds
            logAuthStatus('Setting timeout', `${REFRESH_TIMEOUT/1000}s timeout for silent refresh`);
            
            window._refreshTimeoutId = setTimeout(() => {
                if (window._isRefreshAttempt) {
                    logAuthStatus('Silent refresh timed out', `No response after ${REFRESH_TIMEOUT/1000}s`);
                    window._isRefreshAttempt = false;
                    window._refreshCallbacks = null;
                    
                    // Show the sign-in button instead of leaving user stuck
                    updateLoadingMessage('Sign-in required', 'Silent refresh timed out - please click the button below');
                    document.getElementById('loadingSection').classList.add('hidden');
                    document.getElementById('authSection').classList.remove('hidden');
                    
                    if (onFailure) onFailure(new Error('Silent refresh timed out'));
                }
            }, REFRESH_TIMEOUT);
            
            try {
                logAuthStatus('Requesting token', 'Calling Google OAuth with empty prompt');
                // Empty prompt = silent refresh (no popup if user already consented)
                tokenClient.requestAccessToken({ prompt: '' });
            } catch (error) {
                logAuthStatus('Silent refresh error', error.message);
                clearTimeout(window._refreshTimeoutId);
                window._isRefreshAttempt = false;
                if (onFailure) onFailure(error);
            }
        }
        
        // Global refresh function for app.js to use
        window.refreshGoogleToken = function() {
            return new Promise((resolve, reject) => {
                silentTokenRefresh(resolve, reject);
            });
        };
        
        // ============================================
        // GOOGLE AUTH INITIALIZATION
        // ============================================
        
        function initializeGoogleAuth() {
            logAuthStatus('Initializing', 'Starting Google OAuth setup');
            
            if (typeof google === 'undefined') {
                logAuthStatus('Waiting for API', 'Google Identity Services not loaded yet');
                setTimeout(initializeGoogleAuth, 100);
                return;
            }
            
            logAuthStatus('API loaded', 'Google Identity Services ready');
            
            try {
                // Initialize token client
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CONFIG.GOOGLE_CLIENT_ID,
                    scope: CONFIG.GOOGLE_SCOPES.join(' '),
                    callback: handleTokenResponse,
                    error_callback: (error) => {
                        logAuthStatus('Token client error', JSON.stringify(error));
                        // Clear any pending refresh
                        if (window._refreshTimeoutId) {
                            clearTimeout(window._refreshTimeoutId);
                            window._refreshTimeoutId = null;
                        }
                        window._isRefreshAttempt = false;
                        
                        // Show sign-in button
                        document.getElementById('loadingSection').classList.add('hidden');
                        document.getElementById('authSection').classList.remove('hidden');
                    }
                });
                
                logAuthStatus('Token client created', `Client ID: ${CONFIG.GOOGLE_CLIENT_ID.substring(0, 20)}...`);
                
            } catch (error) {
                logAuthStatus('Init error', error.message);
                showAuthDebugInfo(`Failed to initialize OAuth: ${error.message}`);
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('errorSection').classList.remove('hidden');
                return;
            }
            
            // Render sign-in button
            renderSignInButton();
            
            // Check for existing valid token
            checkExistingToken();
        }
        
        function handleTokenResponse(response) {
            // Clear any pending timeouts
            if (window._refreshTimeoutId) {
                clearTimeout(window._refreshTimeoutId);
                window._refreshTimeoutId = null;
            }
            if (window._signInTimeoutId) {
                clearTimeout(window._signInTimeoutId);
                window._signInTimeoutId = null;
            }
            
            logAuthStatus('Token response received', `Has error: ${!!response.error}, Has token: ${!!response.access_token}`);
            
            const isRefresh = window._isRefreshAttempt;
            const callbacks = window._refreshCallbacks || {};
            window._isRefreshAttempt = false;
            window._refreshCallbacks = null;
            
            if (response.error) {
                logAuthStatus('OAuth error', `${response.error}: ${response.error_description || 'No description'}`);
                
                if (isRefresh) {
                    // Silent refresh failed - this is expected if user logged out of Google
                    logAuthStatus('Silent refresh failed', 'User may need to sign in again');
                    if (callbacks.onFailure) callbacks.onFailure(new Error(response.error));
                    return;
                }
                
                // Regular auth failed
                showAuthDebugInfo(`Authentication failed: ${response.error}${response.error_description ? ' - ' + response.error_description : ''}`);
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('errorSection').classList.remove('hidden');
                return;
            }
            
            if (response.access_token) {
                logAuthStatus('Token received', `Expires in ${response.expires_in || 3600}s`);
                
                // Store token
                const expiresIn = response.expires_in || 3600;
                storeToken(response.access_token, expiresIn);
                
                // Set global variables
                window.accessToken = response.access_token;
                window.globalAccessToken = response.access_token;
                
                if (isRefresh) {
                    logAuthStatus('Silent refresh successful', 'Token refreshed without user interaction');
                    if (callbacks.onSuccess) callbacks.onSuccess(response.access_token);
                    return;
                }
                
                // Initial auth - load app
                logAuthStatus('Initial auth complete', 'Loading app data');
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('loadingSection').classList.remove('hidden');
                updateLoadingMessage('Signed in!', 'Loading calendar data...');
                
                loadAppData();
            } else {
                logAuthStatus('Unexpected response', 'No error but no token received');
                showAuthDebugInfo('Unexpected OAuth response: No error but no token received. Please try again.');
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('errorSection').classList.remove('hidden');
            }
        }
        
        function checkExistingToken() {
            const tokenData = getStoredToken();
            
            if (!tokenData || !tokenData.token) {
                logAuthStatus('No stored token', 'User needs to sign in');
                return;
            }
            
            // Calculate token age and remaining time
            const now = Date.now();
            const tokenAge = now - (tokenData.storedAt || 0);
            const remainingMs = tokenData.expiresAt - now;
            const remainingMin = Math.round(remainingMs / 60000);
            
            logAuthStatus('Found stored token', `Age: ${Math.round(tokenAge/60000)}min, Remaining: ${remainingMin}min`);
            
            if (isTokenValid()) {
                // Token still valid, use it
                logAuthStatus('Token valid', `${remainingMin} minutes remaining`);
                window.accessToken = tokenData.token;
                window.globalAccessToken = tokenData.token;
                
                // Schedule refresh
                scheduleTokenRefresh(Math.floor(remainingMs / 1000));
                
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('loadingSection').classList.remove('hidden');
                updateLoadingMessage('Loading...', 'Using stored credentials');
                
                loadAppData();
                
            } else if (!isTokenExpired()) {
                // Token expiring soon, try refresh
                logAuthStatus('Token expiring soon', 'Attempting proactive refresh');
                window.accessToken = tokenData.token;
                window.globalAccessToken = tokenData.token;
                
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('loadingSection').classList.remove('hidden');
                updateLoadingMessage('Refreshing...', 'Updating credentials');
                
                silentTokenRefresh(
                    () => {
                        logAuthStatus('Proactive refresh succeeded', 'Loading app data');
                        loadAppData();
                    },
                    () => {
                        logAuthStatus('Proactive refresh failed', 'Trying with existing token');
                        loadAppData(); // Try with existing token anyway
                    }
                );
                
            } else {
                // Token expired, try silent refresh
                const expiredAgo = Math.round((now - tokenData.expiresAt) / 60000);
                logAuthStatus('Token expired', `Expired ${expiredAgo} minutes ago, attempting silent refresh`);
                
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('loadingSection').classList.remove('hidden');
                updateLoadingMessage('Signing in...', 'Attempting silent refresh (this may take a moment)');
                
                silentTokenRefresh(
                    (token) => {
                        logAuthStatus('Silent refresh succeeded', 'Loading app data');
                        loadAppData();
                    },
                    (error) => {
                        logAuthStatus('Silent refresh failed', `Error: ${error.message}`);
                        updateLoadingMessage('Sign-in required', 'Please click the button below to sign in');
                        document.getElementById('loadingSection').classList.add('hidden');
                        document.getElementById('authSection').classList.remove('hidden');
                    }
                );
            }
        }
        
        function renderSignInButton() {
            const buttonDiv = document.getElementById("buttonDiv");
            buttonDiv.innerHTML = `
                <button id="customGoogleBtn" style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 12px;
                    background: white;
                    border: 1px solid #dadce0;
                    border-radius: 4px;
                    padding: 10px 12px;
                    font-family: 'Google Sans', Roboto, Arial, sans-serif;
                    font-size: 14px;
                    font-weight: 500;
                    color: #3c4043;
                    cursor: pointer;
                    transition: background-color 0.3s, box-shadow 0.3s;
                    min-width: 17vw;
                " onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.boxShadow='0 1px 2px 0 rgba(60,64,67,.30), 0 1px 3px 1px rgba(60,64,67,.15)';" 
                   onmouseout="this.style.backgroundColor='white'; this.style.boxShadow='none';">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                        <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2.01a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                        <path fill="#FBBC05" d="M4.5 10.52A4.8 4.8 0 0 1 4.5 7.48V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>
                        <path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/>
                    </svg>
                    Sign in with Google
                </button>
                <p id="authStatusHint" style="font-size: 0.75rem; color: #888; margin-top: 0.75rem; cursor: pointer;" 
                   onclick="showAuthStatusPopup()" title="Click for debug info">
                   Having trouble? Click here for debug info
                </p>
            `;
            
            logAuthStatus('Sign-in button rendered', 'Ready for user interaction');
            
            document.getElementById("customGoogleBtn").addEventListener('click', () => {
                logAuthStatus('Sign-in button clicked', 'Requesting access token');
                
                // Show loading state
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('loadingSection').classList.remove('hidden');
                updateLoadingMessage('Signing in...', 'Waiting for Google authentication');
                
                // First sign-in needs consent, subsequent ones are silent
                const tokenData = getStoredToken();
                const prompt = tokenData ? '' : 'consent';
                logAuthStatus('Token request', `Prompt mode: ${prompt || 'silent'}`);
                
                // Set a timeout for manual sign-in as well
                const SIGNIN_TIMEOUT = 60000; // 60 seconds for user interaction
                window._signInTimeoutId = setTimeout(() => {
                    logAuthStatus('Sign-in taking too long', 'User may have closed popup or is taking time');
                    updateLoadingMessage('Still waiting...', 'Complete sign-in in the popup, or click Cancel below');
                }, SIGNIN_TIMEOUT);
                
                try {
                    tokenClient.requestAccessToken({ prompt });
                } catch (error) {
                    logAuthStatus('Request failed', error.message);
                    clearTimeout(window._signInTimeoutId);
                    document.getElementById('loadingSection').classList.add('hidden');
                    document.getElementById('authSection').classList.remove('hidden');
                }
            });
        }
        
        // Show auth status popup for debugging
        function showAuthStatusPopup() {
            const debugLog = authStatusLog.map(e => `[${e.timestamp}] ${e.status}: ${e.details}`).join('\n');
            const storedToken = getStoredToken();
            const tokenInfo = storedToken 
                ? `Token stored: Yes\nExpires: ${new Date(storedToken.expiresAt).toLocaleString()}\nExpired: ${Date.now() > storedToken.expiresAt ? 'Yes' : 'No'}`
                : 'Token stored: No';
            
            alert(`üîç Auth Debug Info\n\n${tokenInfo}\n\nüìã Recent Activity:\n${debugLog || 'No activity logged yet'}\n\nüí° Tip: Open browser console (F12) for more details.`);
        }
        
        // Cancel auth attempt and show sign-in button
        function cancelAuthAndShowSignIn() {
            logAuthStatus('User cancelled', 'Returning to sign-in screen');
            
            // Clear any pending operations
            if (window._refreshTimeoutId) {
                clearTimeout(window._refreshTimeoutId);
                window._refreshTimeoutId = null;
            }
            if (window._signInTimeoutId) {
                clearTimeout(window._signInTimeoutId);
                window._signInTimeoutId = null;
            }
            window._isRefreshAttempt = false;
            window._refreshCallbacks = null;
            
            // Show sign-in
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('authSection').classList.remove('hidden');
        }
        
        // Make functions globally available
        window.showAuthStatusPopup = showAuthStatusPopup;
        window.cancelAuthAndShowSignIn = cancelAuthAndShowSignIn;
        
        function loadAppData() {
            const tryLoad = (attempts = 0) => {
                logAuthStatus('Loading app', `Attempt ${attempts + 1}/10, loadCalendarData available: ${!!window.loadCalendarData}`);
                
                if (window.loadCalendarData) {
                    logAuthStatus('Calling loadCalendarData', 'Fetching calendar events');
                    updateLoadingMessage('Loading calendar...', 'Fetching events');
                    
                    try {
                        window.loadCalendarData();
                    } catch (error) {
                        logAuthStatus('loadCalendarData error', error.message);
                        showAuthDebugInfo(`Failed to load calendar data: ${error.message}`);
                        document.getElementById('loadingSection').classList.add('hidden');
                        document.getElementById('errorSection').classList.remove('hidden');
                    }
                } else if (attempts < 10) {
                    logAuthStatus('Waiting for app.js', `Retry in 500ms (attempt ${attempts + 1})`);
                    setTimeout(() => tryLoad(attempts + 1), 500);
                } else {
                    logAuthStatus('App load failed', 'loadCalendarData not available after 10 attempts');
                    showAuthDebugInfo('Failed to load app: Calendar loader not available. Try refreshing the page.');
                    document.getElementById('loadingSection').classList.add('hidden');
                    document.getElementById('errorSection').classList.remove('hidden');
                }
            };
            tryLoad();
        }
        
        // Start on page load
        window.onload = function() {
            logAuthStatus('Page loaded', `Ready state: ${document.readyState}`);
            initializeGoogleAuth();
        };
        if (document.readyState !== 'loading') {
            logAuthStatus('Document ready', 'Starting auth init');
            setTimeout(initializeGoogleAuth, 100);
        }
        
        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('üì± Service Worker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('üì± Service Worker registration failed:', error);
                    });
            });
        }
        
        // Detect standalone mode and add class to body
        if (window.matchMedia('(display-mode: standalone)').matches || 
            window.navigator.standalone === true) {
            document.body.classList.add('standalone-mode');
            console.log('üì± Running in standalone PWA mode');
        }
    </script>
    
    <!-- Load app.js WITHOUT defer so it's available when we need it -->
    <!-- Cache busting: add timestamp to force reload -->
    <script src="app.js?v=20251221-auth-verbosity"></script>
</body>
</html>
<!-- Reverted to pre-mobile-framework version -->
