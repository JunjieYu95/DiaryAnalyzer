<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Diary Analyzer - Beautiful Calendar Analytics</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Beautiful time series visualization for your Google Calendar diary entries. Track productivity, analyze patterns, and gain insights into how you spend your time.">
    <meta name="keywords" content="calendar analytics, time tracking, productivity, Google Calendar, data visualization, diary analyzer">
    <meta name="author" content="Diary Analyzer">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Diary Analyzer - Beautiful Calendar Analytics">
    <meta property="og:description" content="Beautiful time series visualization for your Google Calendar diary entries. Track productivity and gain insights.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://diary-analyzer.vercel.app">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Diary Analyzer - Beautiful Calendar Analytics">
    <meta name="twitter:description" content="Beautiful time series visualization for your Google Calendar diary entries.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="icons/icon16.svg">
    <link rel="apple-touch-icon" href="icons/icon48.svg">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="styles.css" as="style">
    <link rel="preload" href="https://accounts.google.com/gsi/client" as="script">
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Load Google API Client Library for proper OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <h1>üìä Diary Analyzer</h1>
                <p class="header-subtitle">Beautiful time series visualization for your Google Calendar diary entries</p>
                <div class="controls">
                    <button id="refreshBtn" class="refresh-btn">üîÑ Refresh</button>
                    <button id="signOutBtn" class="signout-btn hidden">üö™ Sign Out</button>
                </div>
            </div>
        </header>

        <main class="app-main">
            <!-- Auth Section -->
            <section id="authSection" class="auth-section">
                <div class="auth-card">
                    <h2>üìä Welcome to Diary Analyzer</h2>
                    <p>Sign in with your Google account to view and analyze your calendar diary entries</p>
                    
                    <!-- Custom Sign-In Button with OAuth Token Request -->
                    <div id="buttonDiv"></div>
                    
                    <p class="auth-note">We only request read-only access to your calendar data</p>
                </div>
            </section>

            <!-- Loading Section -->
            <section id="loadingSection" class="loading-section hidden">
                    <div class="loading-spinner"></div>
                <p id="loadingMessage">Loading your calendar data...</p>
                <p id="loadingDetails" style="font-size: 0.85rem; color: #888; margin-top: 0.5rem;"></p>
            </section>

            <!-- Error Section -->
            <section id="errorSection" class="error-section hidden">
                <div class="error-card">
                    <h2>‚ö†Ô∏è Something went wrong</h2>
                    <p id="errorMessage"></p>
                    <button id="retryBtn" class="retry-btn">Try Again</button>
                </div>
            </section>

            <!-- Content Section -->
            <section id="contentSection" class="content-section">
                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button id="highlightsTab" class="tab-btn active">‚≠ê Highlights & Milestones</button>
                    <button id="analyticsTab" class="tab-btn">üìä Analytics</button>
                </div>
                
                <!-- Highlights Tab Content -->
                <div id="highlightsTabContent" class="tab-content active">
                <!-- Main Calendar View -->
                <div class="main-calendar-view">
                    <div class="calendar-header">
                        <h2>‚≠ê Highlights & Milestones Calendar</h2>
                        <div class="calendar-controls">
                            <button id="prevYear" class="calendar-nav-btn">‚Üê Previous Year</button>
                            <span id="currentYear" class="current-year">2024</span>
                            <button id="nextYear" class="calendar-nav-btn">Next Year ‚Üí</button>
                        </div>
                        <button id="highlightsLogButton" class="log-btn">üìù Log Highlight</button>
                    </div>
                    <div class="calendar-wrapper">
                        <div id="calendarGrid" class="calendar-grid">
                            <!-- Calendar will be dynamically generated here -->
                        </div>
                    </div>
                </div>
                </div> <!-- End Highlights Tab Content -->
                
                <!-- Analytics Tab Content -->
                <div id="analyticsTabContent" class="tab-content">
                    <!-- Analytics Controls -->
                    <div class="analytics-controls">
                        <select id="dateRange" class="date-selector">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                        </select>
                        <select id="viewMode" class="view-selector">
                            <option value="distribution">Distribution</option>
                            <option value="timeline">Timeline</option>
                            <option value="advanced">Advanced Analytics</option>
                            <option value="aggregated">Category Trends</option>
                        </select>
                        <button id="logButton" class="log-btn">üìù Quick Log</button>
                        <button id="randomRecapBtn" class="random-recap-btn">üé≤ Random Recap</button>
                    </div>
                    
                    <div class="stats-container">
                    <div class="stat-card">
                        <h3>Total Events</h3>
                        <p id="totalEvents" class="stat-value">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Active Hours</h3>
                        <p id="activeHours" class="stat-value">0h 0m</p>
                    </div>
                    <div class="stat-card">
                        <h3>Most Common</h3>
                        <p id="mostCommon" class="stat-value">-</p>
                </div>
            </div>

                <!-- Navigation -->
                <div class="date-navigation">
                    <button id="prevDay" class="nav-btn">‚Üê Prev</button>
                    <span id="currentDate" class="current-date">Today</span>
                    <button id="nextDay" class="nav-btn">Next ‚Üí</button>
                </div>

                <!-- Timeline View -->
                <div id="timelineContainer" class="timeline-container hidden">
                    <h3>Timeline</h3>
                    <div id="timeline" class="timeline"></div>
                </div>

                <!-- Distribution View -->
                <div id="distributionContainer" class="distribution-container">
                    <h3>Time Distribution</h3>
                    <p class="distribution-subtitle">Daily time distribution by calendar</p>
                    <div id="distributionChart" class="distribution-chart"></div>
                    <div id="distributionStats" class="distribution-stats"></div>
                </div>

                <!-- Advanced Analytics View -->
                <div id="advancedContainer" class="advanced-container hidden">
                    <h3>Advanced Analytics</h3>
                    <div id="advancedCharts" class="advanced-charts">
                        <!-- Charts will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Aggregated Category Trends View -->
                <div id="aggregatedContainer" class="aggregated-container hidden">
                    <h3>Category Trends</h3>
                    <div class="aggregated-controls">
                        <div class="control-group">
                            <label for="aggregationPeriod">Aggregation Period:</label>
                            <select id="aggregationPeriod" class="period-selector">
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="showEventCount">Show Event Count:</label>
                            <input type="checkbox" id="showEventCount" class="event-count-toggle">
                        </div>
                        <div class="control-group">
                            <button id="refreshCategoryTrends" class="refresh-category-btn">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div id="aggregatedChart" class="aggregated-chart">
                        <!-- Chart will be dynamically inserted here -->
                    </div>
                </div>
                </div> <!-- End Analytics Tab Content -->
            </section>
        </main>
        
        <!-- Day Details Popup Modal -->
        <div id="dayDetailsModal" class="day-details-modal hidden">
            <div class="day-details-modal-content">
                <div class="day-details-header">
                    <h2 id="dayDetailsTitle">Day Details</h2>
                    <button class="day-details-close" onclick="closeDayDetailsModal()">&times;</button>
                </div>
                <div class="day-details-content">
                    <div id="dayDetailsDate" class="day-details-date"></div>
                    <div id="dayDetailsEvents" class="day-details-events">
                        <!-- Calendar events will be shown here -->
                    </div>
                    <div id="dayDetailsHighlights" class="day-details-highlights">
                        <!-- Highlights and milestones will be shown here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Random Recap Popup Modal -->
        <div id="randomRecapModal" class="random-recap-modal hidden">
            <div class="random-recap-modal-content">
                <div class="random-recap-header">
                    <h2>üé≤ Random Recap</h2>
                    <button class="random-recap-close" onclick="closeRandomRecapModal()">&times;</button>
                </div>
                
                <div class="random-recap-settings">
                    <h3>Settings</h3>
                    <div class="random-recap-form-group">
                        <label for="lookbackPeriod">Lookback Period:</label>
                        <select id="lookbackPeriod" class="random-recap-lookback-select">
                            <option value="7">1 Week</option>
                            <option value="30">1 Month</option>
                            <option value="90">3 Months</option>
                            <option value="180">6 Months</option>
                            <option value="365" selected>1 Year</option>
                            <option value="730">2 Years</option>
                        </select>
                        <button id="generateRandomRecap" class="random-recap-generate-btn">üé≤ Generate Random Day</button>
                    </div>
                </div>
                
                <div class="random-recap-content">
                    <div class="random-recap-loading hidden">
                        <div class="random-recap-loading-spinner"></div>
                        <p>Finding a random day with activities...</p>
                    </div>
                    <div id="randomRecapResults"></div>
                </div>
            </div>
        </div>

        <!-- Log Highlight Popup Modal -->
        <div id="logModal" class="log-modal hidden">
            <div class="log-modal-content">
                <div class="log-modal-header">
                    <h2>üìù Log Highlight or Milestone</h2>
                    <button class="log-modal-close" onclick="closeHighlightModal()">&times;</button>
                </div>
                
                <div class="log-modal-body">
                    <form id="logForm" class="log-form">
                        <div class="form-group">
                            <label for="highlightDate">Date:</label>
                            <input type="date" id="highlightDate" name="highlightDate" class="date-input" required>
                        </div>
                        <div class="form-group">
                            <label for="highlightTitle">Title:</label>
                            <input type="text" id="highlightTitle" name="highlightTitle" class="title-input" placeholder="Enter highlight or milestone title" required>
                        </div>
                        <div class="form-group">
                            <label for="highlightDescription">Description:</label>
                            <textarea id="highlightDescription" name="highlightDescription" class="description-input" placeholder="Enter description (optional)"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="highlightType">Type:</label>
                            <select id="highlightType" name="highlightType" class="type-select" required>
                                <option value="highlight">Highlight</option>
                                <option value="milestone">Milestone</option>
                                <option value="achievement">Achievement</option>
                                <option value="memory">Memory</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="cancel-btn" onclick="closeHighlightModal()">Cancel</button>
                            <button type="submit" id="saveHighlight" class="save-highlight-btn">üíæ Save Highlight</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <footer class="app-footer">
            ¬© 2024 Diary Analyzer. Made with ‚ù§Ô∏è for productivity enthusiasts.
        </footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- config.js must load BEFORE app.js, so no defer -->
    <script src="config.js"></script>
    
    <!-- Google OAuth Setup - REQUEST ACCESS TOKEN NOT ID TOKEN -->
    <script>
        let tokenClient;
        let tokenRefreshTimer = null;
        // Note: accessToken is declared in app.js, we'll just use window.accessToken
        
        // Helper function to update loading message with details
        function updateLoadingMessage(mainMessage, details = '') {
            const loadingMsg = document.getElementById('loadingMessage');
            const loadingDetails = document.getElementById('loadingDetails');
            if (loadingMsg) loadingMsg.textContent = mainMessage;
            if (loadingDetails) loadingDetails.textContent = details;
            console.log('üì¢', mainMessage, details ? `(${details})` : '');
        }
        
        // ============================================
        // TOKEN REFRESH SYSTEM
        // ============================================
        
        // Store token with expiration info
        function storeTokenWithExpiration(accessToken, expiresIn) {
            const expiresAt = Date.now() + (expiresIn * 1000);
            const tokenData = {
                token: accessToken,
                expiresAt: expiresAt,
                expiresIn: expiresIn
            };
            localStorage.setItem('googleTokenData', JSON.stringify(tokenData));
            localStorage.setItem('googleToken', accessToken); // Keep for backward compatibility
            console.log('üíæ Token stored with expiration:', new Date(expiresAt).toLocaleString());
            console.log('‚è±Ô∏è Token expires in:', Math.round(expiresIn / 60), 'minutes');
            
            // Schedule proactive refresh (5 minutes before expiration)
            scheduleTokenRefresh(expiresIn);
        }
        
        // Get stored token data
        function getStoredTokenData() {
            try {
                const data = localStorage.getItem('googleTokenData');
                if (data) {
                    return JSON.parse(data);
                }
            } catch (e) {
                console.error('‚ùå Error parsing token data:', e);
            }
            return null;
        }
        
        // Check if token is expired or about to expire (within 5 minutes)
        function isTokenExpiredOrExpiring() {
            const tokenData = getStoredTokenData();
            if (!tokenData || !tokenData.expiresAt) {
                // No expiration data, assume it might be expired
                return true;
            }
            // Consider expired if less than 5 minutes remaining
            const fiveMinutes = 5 * 60 * 1000;
            return Date.now() > (tokenData.expiresAt - fiveMinutes);
        }
        
        // Check if token is completely expired
        function isTokenFullyExpired() {
            const tokenData = getStoredTokenData();
            if (!tokenData || !tokenData.expiresAt) {
                return true;
            }
            return Date.now() > tokenData.expiresAt;
        }
        
        // Schedule proactive token refresh
        function scheduleTokenRefresh(expiresIn) {
            // Clear any existing timer
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
            }
            
            // Refresh 5 minutes before expiration (or at 80% of token lifetime)
            const refreshIn = Math.max(
                (expiresIn * 1000) - (5 * 60 * 1000), // 5 minutes before expiration
                (expiresIn * 1000) * 0.8 // or 80% of token lifetime
            );
            
            console.log('‚è∞ Scheduling token refresh in:', Math.round(refreshIn / 60000), 'minutes');
            
            tokenRefreshTimer = setTimeout(() => {
                console.log('üîÑ Proactive token refresh triggered...');
                silentTokenRefresh();
            }, refreshIn);
        }
        
        // Silent token refresh - attempts to get new token without user interaction
        function silentTokenRefresh(onSuccess, onFailure) {
            console.log('üîÑ Attempting silent token refresh...');
            
            if (!tokenClient) {
                console.error('‚ùå Token client not initialized');
                if (onFailure) onFailure(new Error('Token client not initialized'));
                return;
            }
            
            // Store callbacks for the token client callback to use
            window._tokenRefreshCallbacks = { onSuccess, onFailure };
            window._isRefreshAttempt = true;
            
            try {
                // Request token with empty prompt for silent refresh
                // If user has already consented, this won't show any popup
                tokenClient.requestAccessToken({ prompt: '' });
            } catch (error) {
                console.error('‚ùå Silent refresh failed:', error);
                window._isRefreshAttempt = false;
                if (onFailure) onFailure(error);
            }
        }
        
        // Expose refresh function globally for app.js to use on 401 errors
        window.refreshGoogleToken = function() {
            return new Promise((resolve, reject) => {
                silentTokenRefresh(
                    (newToken) => {
                        console.log('‚úÖ Token refreshed successfully via promise');
                        resolve(newToken);
                    },
                    (error) => {
                        console.error('‚ùå Token refresh failed via promise:', error);
                        reject(error);
                    }
                );
            });
        };
        
        // Check token validity and refresh if needed
        window.ensureValidToken = async function() {
            if (isTokenExpiredOrExpiring()) {
                console.log('üîÑ Token expired or expiring soon, refreshing...');
                try {
                    await window.refreshGoogleToken();
                    return window.accessToken;
                } catch (error) {
                    console.error('‚ùå Failed to refresh token:', error);
                    throw error;
                }
            }
            return window.accessToken;
        };
        
        // ============================================
        // GOOGLE AUTH INITIALIZATION
        // ============================================
        
        // Wait for Google API to load completely
        function initializeGoogleAuth() {
            console.log('üîß Initializing Google OAuth...');
            
            // Check if google object exists
            if (typeof google === 'undefined') {
                console.log('‚è≥ Google API not loaded yet, retrying...');
                setTimeout(initializeGoogleAuth, 100);
                return;
            }
            
            console.log('‚úÖ Google API loaded, setting up OAuth...');
            
            // Initialize the Token Client for OAuth 2.0
            // Client ID comes from config.js - never hardcode credentials
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar',
                callback: (response) => {
                    console.log('üîê OAuth Token Response:', response);
                    
                    // Check if this is a refresh attempt
                    const isRefresh = window._isRefreshAttempt;
                    const callbacks = window._tokenRefreshCallbacks || {};
                    window._isRefreshAttempt = false;
                    window._tokenRefreshCallbacks = null;
                    
                    if (response.error) {
                        console.error('‚ùå OAuth Error:', response.error);
                        
                        if (isRefresh && callbacks.onFailure) {
                            callbacks.onFailure(new Error(response.error));
                            return;
                        }
                        
                        // For non-refresh failures, show auth section
                        document.getElementById('errorMessage').textContent = `Authentication failed: ${response.error}`;
                        document.getElementById('authSection').classList.add('hidden');
                        document.getElementById('errorSection').classList.remove('hidden');
                        return;
                    }
                    
                    if (response.access_token) {
                        console.log('‚úÖ Got ACCESS TOKEN (length:', response.access_token.length, ')');
                        console.log('üîë Token preview:', response.access_token.substring(0, 30) + '...');
                        console.log('‚è±Ô∏è Token expires_in:', response.expires_in, 'seconds');
                        
                        // THIS IS A REAL ACCESS TOKEN - IT WORKS WITH APIs!
                        window.accessToken = response.access_token;
                        window.globalAccessToken = response.access_token;
                        
                        // Store token WITH EXPIRATION INFO
                        const expiresIn = response.expires_in || 3600; // Default 1 hour if not provided
                        storeTokenWithExpiration(response.access_token, expiresIn);
                        
                        // If this was a refresh, call success callback and return
                        if (isRefresh && callbacks.onSuccess) {
                            console.log('üîÑ Silent refresh completed successfully');
                            callbacks.onSuccess(response.access_token);
                            return;
                        }
                        
                        // Show loading and load data (for initial auth)
                        document.getElementById('authSection').classList.add('hidden');
                        document.getElementById('loadingSection').classList.remove('hidden');
                        updateLoadingMessage('Authentication successful!', 'Initializing calendar API...');
                        
                        // Load calendar data with retry logic
                        const tryLoadCalendarData = (attempts = 0, maxAttempts = 10) => {
                            console.log(`üîÑ Attempt ${attempts + 1}/${maxAttempts} to load calendar data...`);
                            
                            if (window.loadCalendarData && typeof window.loadCalendarData === 'function') {
                                console.log('‚úÖ Found loadCalendarData function, calling it...');
                                updateLoadingMessage('Loading calendar data...', 'Fetching events from Google Calendar...');
                                try {
                                    window.loadCalendarData();
                                } catch (error) {
                                    console.error('‚ùå Error calling loadCalendarData:', error);
                                    document.getElementById('errorMessage').textContent = `Failed to load calendar data: ${error.message}`;
                                    document.getElementById('loadingSection').classList.add('hidden');
                                    document.getElementById('errorSection').classList.remove('hidden');
                                }
                            } else if (attempts < maxAttempts) {
                                const nextAttempt = attempts + 1;
                                const waitTime = 500;
                                console.log(`‚è≥ loadCalendarData not ready yet, retrying in ${waitTime}ms... (${nextAttempt}/${maxAttempts})`);
                                updateLoadingMessage('Loading calendar data...', `Waiting for app.js... (${nextAttempt}/${maxAttempts})`);
                                setTimeout(() => tryLoadCalendarData(nextAttempt, maxAttempts), waitTime);
                            } else {
                                console.error('‚ùå Failed to load app.js after', maxAttempts, 'attempts');
                                document.getElementById('errorMessage').textContent = 'Failed to load app.js. Please refresh the page.';
                                document.getElementById('loadingSection').classList.add('hidden');
                                document.getElementById('errorSection').classList.remove('hidden');
                            }
                        };
                        
                        tryLoadCalendarData();
                    }
                },
            });
            
            console.log('üé® Rendering sign-in button...');
            
            // Create a custom button (Google's renderButton only works with ID tokens)
            const buttonDiv = document.getElementById("buttonDiv");
            buttonDiv.innerHTML = `
                <button id="customGoogleBtn" style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 12px;
                    background: white;
                    border: 1px solid #dadce0;
                    border-radius: 4px;
                    padding: 10px 12px;
                    font-family: 'Google Sans', Roboto, Arial, sans-serif;
                    font-size: 14px;
                    font-weight: 500;
                    color: #3c4043;
                    cursor: pointer;
                    transition: background-color 0.3s, box-shadow 0.3s;
                    min-width: 17vw;
                " onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.boxShadow='0 1px 2px 0 rgba(60,64,67,.30), 0 1px 3px 1px rgba(60,64,67,.15)';" 
                   onmouseout="this.style.backgroundColor='white'; this.style.boxShadow='none';">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                        <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2.01a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                        <path fill="#FBBC05" d="M4.5 10.52A4.8 4.8 0 0 1 4.5 7.48V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>
                        <path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/>
                    </svg>
                    Sign in with Google
                </button>
            `;
            
            document.getElementById("customGoogleBtn").addEventListener('click', () => {
                console.log('üñ±Ô∏è Sign-in button clicked - requesting access token...');
                // Request an access token (consent prompt for new users)
                tokenClient.requestAccessToken({prompt: 'consent'});
            });
            
            console.log('‚úÖ Sign-in button rendered successfully');
            
            // Check if we already have a valid token
            const tokenData = getStoredTokenData();
            const storedToken = localStorage.getItem('googleToken');
            
            if (storedToken && storedToken.length < 500) {
                // Check if token is expired
                if (tokenData && !isTokenFullyExpired()) {
                    console.log('‚ôªÔ∏è Found valid stored access token, using it...');
                    window.accessToken = storedToken;
                    window.globalAccessToken = storedToken;
                    
                    // Schedule refresh based on remaining time
                    const remainingMs = tokenData.expiresAt - Date.now();
                    const remainingSec = Math.max(60, Math.floor(remainingMs / 1000));
                    scheduleTokenRefresh(remainingSec);
                    
                    console.log('‚è±Ô∏è Token valid for:', Math.round(remainingMs / 60000), 'more minutes');
                    
                    // Try loading data
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('loadingSection').classList.remove('hidden');
                    updateLoadingMessage('Using stored credentials...', 'Initializing...');
                    
                    // Use the same retry logic
                    const tryLoadCalendarData = (attempts = 0, maxAttempts = 10) => {
                        console.log(`üîÑ Attempt ${attempts + 1}/${maxAttempts} to load calendar data...`);
                        
                        if (window.loadCalendarData && typeof window.loadCalendarData === 'function') {
                            console.log('‚úÖ Found loadCalendarData function, calling it...');
                            updateLoadingMessage('Loading calendar data...', 'Fetching events from Google Calendar...');
                            try {
                                window.loadCalendarData();
                            } catch (error) {
                                console.error('‚ùå Error calling loadCalendarData:', error);
                                document.getElementById('errorMessage').textContent = `Failed to load calendar data: ${error.message}`;
                                document.getElementById('loadingSection').classList.add('hidden');
                                document.getElementById('errorSection').classList.remove('hidden');
                            }
                        } else if (attempts < maxAttempts) {
                            const nextAttempt = attempts + 1;
                            const waitTime = 500;
                            console.log(`‚è≥ loadCalendarData not ready yet, retrying in ${waitTime}ms... (${nextAttempt}/${maxAttempts})`);
                            updateLoadingMessage('Loading calendar data...', `Waiting for app.js... (${nextAttempt}/${maxAttempts})`);
                            setTimeout(() => tryLoadCalendarData(nextAttempt, maxAttempts), waitTime);
                        } else {
                            console.error('‚ùå Failed to load app.js after', maxAttempts, 'attempts');
                            document.getElementById('errorMessage').textContent = 'Failed to load app.js. Please refresh the page.';
                            document.getElementById('loadingSection').classList.add('hidden');
                            document.getElementById('errorSection').classList.remove('hidden');
                        }
                    };
                    
                    tryLoadCalendarData();
                } else if (storedToken) {
                    // Token exists but is expired - try silent refresh
                    console.log('üîÑ Stored token expired, attempting silent refresh...');
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('loadingSection').classList.remove('hidden');
                    updateLoadingMessage('Refreshing credentials...', 'Please wait...');
                    
                    silentTokenRefresh(
                        (newToken) => {
                            console.log('‚úÖ Silent refresh successful on page load');
                            updateLoadingMessage('Credentials refreshed!', 'Loading calendar data...');
                            
                            // Load calendar data
                            const tryLoadCalendarData = (attempts = 0, maxAttempts = 10) => {
                                if (window.loadCalendarData && typeof window.loadCalendarData === 'function') {
                                    try {
                                        window.loadCalendarData();
                                    } catch (error) {
                                        console.error('‚ùå Error loading calendar:', error);
                                        document.getElementById('loadingSection').classList.add('hidden');
                                        document.getElementById('errorSection').classList.remove('hidden');
                                    }
                                } else if (attempts < maxAttempts) {
                                    setTimeout(() => tryLoadCalendarData(attempts + 1, maxAttempts), 500);
                                }
                            };
                            tryLoadCalendarData();
                        },
                        (error) => {
                            console.log('‚ö†Ô∏è Silent refresh failed, showing sign-in button');
                            document.getElementById('loadingSection').classList.add('hidden');
                            document.getElementById('authSection').classList.remove('hidden');
                        }
                    );
                }
            } else {
                console.log('üîç No stored token found');
            }
        }
        
        // Start initialization when page loads
        window.onload = initializeGoogleAuth;
        
        // Also try when DOM is ready (backup)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGoogleAuth);
        } else {
            initializeGoogleAuth();
        }
    </script>
    
    <!-- Load app.js WITHOUT defer so it's available when we need it -->
    <!-- Cache busting: add timestamp to force reload -->
    <script src="app.js?v=20251220-autorefresh"></script>
</body>
</html>
<!-- Reverted to pre-mobile-framework version -->
