<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Diary Analyzer - Beautiful Calendar Analytics</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Beautiful time series visualization for your Google Calendar diary entries. Track productivity, analyze patterns, and gain insights into how you spend your time.">
    <meta name="keywords" content="calendar analytics, time tracking, productivity, Google Calendar, data visualization, diary analyzer">
    <meta name="author" content="Diary Analyzer">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Diary Analyzer - Beautiful Calendar Analytics">
    <meta property="og:description" content="Beautiful time series visualization for your Google Calendar diary entries. Track productivity and gain insights.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://diary-analyzer.vercel.app">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Diary Analyzer - Beautiful Calendar Analytics">
    <meta name="twitter:description" content="Beautiful time series visualization for your Google Calendar diary entries.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="icons/icon16.svg">
    <link rel="apple-touch-icon" href="icons/icon48.svg">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="styles.css" as="style">
    <link rel="preload" href="https://accounts.google.com/gsi/client" as="script">
    
    <!-- Mobile-First Framework -->
    <link rel="stylesheet" href="mobile-framework.css">
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Load Google API Client Library for proper OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="app-container">
        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <div class="mobile-nav-content">
                <h1 class="mobile-nav-title">üìä Diary Analyzer</h1>
                <div class="mobile-nav-actions">
                    <button id="refreshBtn" class="mobile-btn mobile-btn-sm mobile-btn-secondary">üîÑ</button>
                    <button id="signOutBtn" class="mobile-btn mobile-btn-sm mobile-btn-secondary hidden">üö™</button>
                </div>
            </div>
        </nav>

        <main class="app-main mobile-p-4">
            <!-- Auth Section -->
            <section id="authSection" class="mobile-card mobile-m-4">
                <div class="mobile-card-body mobile-text-center">
                    <h2 class="mobile-text-2xl mobile-font-bold mobile-mb-4">üìä Welcome to Diary Analyzer</h2>
                    <p class="mobile-text-gray-600 mobile-mb-6">Sign in with your Google account to view and analyze your calendar diary entries</p>
                    
                    <!-- Custom Sign-In Button with OAuth Token Request -->
                    <div id="buttonDiv" class="mobile-mb-4"></div>
                    
                    <p class="mobile-text-sm mobile-text-gray-500">We only request read-only access to your calendar data</p>
                </div>
            </section>

            <!-- Loading Section -->
            <section id="loadingSection" class="mobile-card mobile-m-4 mobile-hidden">
                <div class="mobile-card-body mobile-text-center">
                    <div class="loading-spinner mobile-mx-auto mobile-mb-4"></div>
                    <p id="loadingMessage" class="mobile-text-lg mobile-font-medium mobile-mb-2">Loading your calendar data...</p>
                    <p id="loadingDetails" class="mobile-text-sm mobile-text-gray-500"></p>
                </div>
            </section>

            <!-- Error Section -->
            <section id="errorSection" class="mobile-card mobile-m-4 mobile-hidden">
                <div class="mobile-card-body mobile-text-center">
                    <h2 class="mobile-text-xl mobile-font-bold mobile-text-error mobile-mb-4">‚ö†Ô∏è Something went wrong</h2>
                    <p id="errorMessage" class="mobile-text-gray-600 mobile-mb-6"></p>
                    <button id="retryBtn" class="mobile-btn mobile-btn-primary mobile-btn-full">Try Again</button>
                </div>
            </section>

            <!-- Content Section -->
            <section id="contentSection" class="mobile-hidden">
                <!-- Mobile Controls -->
                <div class="mobile-card mobile-m-4">
                    <div class="mobile-card-body">
                        <div class="mobile-form-group mobile-mb-4">
                            <label class="mobile-form-label">Date Range</label>
                            <select id="dateRange" class="mobile-form-select">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        <div class="mobile-form-group mobile-mb-4">
                            <label class="mobile-form-label">View Mode</label>
                            <select id="viewMode" class="mobile-form-select">
                                <option value="distribution">Distribution</option>
                                <option value="timeline">Timeline</option>
                                <option value="advanced">Advanced Analytics</option>
                            </select>
                        </div>
                        <div class="mobile-flex mobile-flex-wrap mobile-gap-2">
                            <button id="logButton" class="mobile-btn mobile-btn-primary mobile-btn-sm">üìù Quick Log</button>
                            <button id="randomRecapBtn" class="mobile-btn mobile-btn-success mobile-btn-sm">üé≤ Random Recap</button>
                        </div>
                    </div>
                </div>

                <!-- Mobile Stats -->
                <div class="mobile-stats-grid mobile-m-4">
                    <div class="mobile-stat-card">
                        <div id="totalEvents" class="mobile-stat-value">0</div>
                        <div class="mobile-stat-label">Total Events</div>
                    </div>
                    <div class="mobile-stat-card">
                        <div id="activeHours" class="mobile-stat-value">0h 0m</div>
                        <div class="mobile-stat-label">Active Hours</div>
                    </div>
                    <div class="mobile-stat-card">
                        <div id="mostCommon" class="mobile-stat-value">-</div>
                        <div class="mobile-stat-label">Most Common</div>
                    </div>
                </div>

                <!-- Mobile Date Navigation -->
                <div class="mobile-card mobile-m-4">
                    <div class="mobile-card-body">
                        <div class="mobile-flex mobile-justify-between mobile-items-center">
                            <button id="prevDay" class="mobile-btn mobile-btn-secondary mobile-btn-sm">‚Üê Prev</button>
                            <span id="currentDate" class="mobile-text-lg mobile-font-semibold mobile-text-center">Today</span>
                            <button id="nextDay" class="mobile-btn mobile-btn-secondary mobile-btn-sm">Next ‚Üí</button>
                        </div>
                    </div>
                </div>

                <!-- Timeline View -->
                <div id="timelineContainer" class="mobile-card mobile-m-4 mobile-hidden">
                    <div class="mobile-card-header">
                        <h3 class="mobile-text-xl mobile-font-bold mobile-text-center">Timeline</h3>
                    </div>
                    <div class="mobile-card-body">
                        <div id="timeline" class="mobile-timeline"></div>
                    </div>
                </div>

                <!-- Distribution View -->
                <div id="distributionContainer" class="mobile-card mobile-m-4">
                    <div class="mobile-card-header">
                        <h3 class="mobile-text-xl mobile-font-bold mobile-text-center">Time Distribution</h3>
                        <p class="mobile-text-sm mobile-text-gray-500 mobile-text-center mobile-mt-2">Daily time distribution by calendar</p>
                    </div>
                    <div class="mobile-card-body">
                        <div id="distributionChart" class="mobile-chart-container">
                            <div class="mobile-chart-content">
                                <!-- Chart will be rendered here -->
                            </div>
                        </div>
                        <div id="distributionStats" class="mobile-stats-grid mobile-mt-4"></div>
                    </div>
                </div>

                <!-- Advanced Analytics View -->
                <div id="advancedContainer" class="mobile-card mobile-m-4 mobile-hidden">
                    <div class="mobile-card-header">
                        <h3 class="mobile-text-xl mobile-font-bold mobile-text-center">Advanced Analytics</h3>
                    </div>
                    <div class="mobile-card-body">
                        <div id="advancedCharts" class="mobile-chart-container">
                            <!-- Charts will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- Random Recap Mobile Modal -->
        <div id="randomRecapModal" class="mobile-modal mobile-hidden">
            <div class="mobile-modal-content">
                <div class="mobile-modal-header">
                    <h2 class="mobile-modal-title">üé≤ Random Recap</h2>
                    <button class="mobile-modal-close" onclick="closeRandomRecapModal()">&times;</button>
                </div>
                
                <div class="mobile-modal-body">
                    <div class="mobile-card mobile-mb-4">
                        <div class="mobile-card-body">
                            <h3 class="mobile-text-lg mobile-font-semibold mobile-mb-4">Settings</h3>
                            <div class="mobile-form-group mobile-mb-4">
                                <label for="lookbackPeriod" class="mobile-form-label">Lookback Period</label>
                                <select id="lookbackPeriod" class="mobile-form-select">
                                    <option value="7">1 Week</option>
                                    <option value="30">1 Month</option>
                                    <option value="90">3 Months</option>
                                    <option value="180">6 Months</option>
                                    <option value="365" selected>1 Year</option>
                                    <option value="730">2 Years</option>
                                </select>
                            </div>
                            <button id="generateRandomRecap" class="mobile-btn mobile-btn-success mobile-btn-full">üé≤ Generate Random Day</button>
                        </div>
                    </div>
                    
                    <div class="random-recap-loading mobile-hidden">
                        <div class="mobile-text-center mobile-p-8">
                            <div class="loading-spinner mobile-mx-auto mobile-mb-4"></div>
                            <p class="mobile-text-gray-600">Finding a random day with activities...</p>
                        </div>
                    </div>
                    <div id="randomRecapResults"></div>
                </div>
            </div>
        </div>
        
        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-bottom-nav">
            <div class="mobile-bottom-nav-content">
                <a href="#" class="mobile-bottom-nav-item active" data-view="distribution">
                    <div class="mobile-bottom-nav-icon">üìä</div>
                    <div class="mobile-bottom-nav-label">Distribution</div>
                </a>
                <a href="#" class="mobile-bottom-nav-item" data-view="timeline">
                    <div class="mobile-bottom-nav-icon">üìÖ</div>
                    <div class="mobile-bottom-nav-label">Timeline</div>
                </a>
                <a href="#" class="mobile-bottom-nav-item" data-view="advanced">
                    <div class="mobile-bottom-nav-icon">üìà</div>
                    <div class="mobile-bottom-nav-label">Analytics</div>
                </a>
                <a href="#" class="mobile-bottom-nav-item" data-action="random-recap">
                    <div class="mobile-bottom-nav-icon">üé≤</div>
                    <div class="mobile-bottom-nav-label">Random</div>
                </a>
            </div>
        </nav>
        
        <footer class="mobile-text-center mobile-p-4 mobile-text-white mobile-text-sm">
            ¬© 2024 Diary Analyzer. Made with ‚ù§Ô∏è for productivity enthusiasts.
        </footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- config.js must load BEFORE app.js, so no defer -->
    <script src="config.js"></script>
    
    <!-- Google OAuth Setup - REQUEST ACCESS TOKEN NOT ID TOKEN -->
    <script>
        let tokenClient;
        // Note: accessToken is declared in app.js, we'll just use window.accessToken
        
        // Helper function to update loading message with details
        function updateLoadingMessage(mainMessage, details = '') {
            const loadingMsg = document.getElementById('loadingMessage');
            const loadingDetails = document.getElementById('loadingDetails');
            if (loadingMsg) loadingMsg.textContent = mainMessage;
            if (loadingDetails) loadingDetails.textContent = details;
            console.log('üì¢', mainMessage, details ? `(${details})` : '');
        }
        
        // Wait for Google API to load completely
        function initializeGoogleAuth() {
            console.log('üîß Initializing Google OAuth...');
            
            // Check if google object exists
            if (typeof google === 'undefined') {
                console.log('‚è≥ Google API not loaded yet, retrying...');
                setTimeout(initializeGoogleAuth, 100);
                return;
            }
            
            console.log('‚úÖ Google API loaded, setting up OAuth...');
            
            // Initialize the Token Client for OAuth 2.0
            // Client ID comes from config.js - never hardcode credentials
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/calendar.events',
                callback: (response) => {
                    console.log('üîê OAuth Token Response:', response);
                    
                    if (response.error) {
                        console.error('‚ùå OAuth Error:', response.error);
                        document.getElementById('errorMessage').textContent = `Authentication failed: ${response.error}`;
                        document.getElementById('authSection').classList.add('hidden');
                        document.getElementById('errorSection').classList.remove('hidden');
                        return;
                    }
                    
                    if (response.access_token) {
                        console.log('‚úÖ Got ACCESS TOKEN (length:', response.access_token.length, ')');
                        console.log('üîë Token preview:', response.access_token.substring(0, 30) + '...');
                        
                        // THIS IS A REAL ACCESS TOKEN - IT WORKS WITH APIs!
                        window.accessToken = response.access_token;
                        window.globalAccessToken = response.access_token;
                        
                        // Store token
                        localStorage.setItem('googleToken', response.access_token);
                        console.log('üíæ Access token stored');
                        
                        // Show loading and load data
                        document.getElementById('authSection').classList.add('hidden');
                        document.getElementById('loadingSection').classList.remove('hidden');
                        updateLoadingMessage('Authentication successful!', 'Initializing calendar API...');
                        
                        // Load calendar data with retry logic
                        const tryLoadCalendarData = (attempts = 0, maxAttempts = 10) => {
                            console.log(`üîÑ Attempt ${attempts + 1}/${maxAttempts} to load calendar data...`);
                            
                            if (window.loadCalendarData && typeof window.loadCalendarData === 'function') {
                                console.log('‚úÖ Found loadCalendarData function, calling it...');
                                updateLoadingMessage('Loading calendar data...', 'Fetching events from Google Calendar...');
                                try {
                                    window.loadCalendarData();
                                } catch (error) {
                                    console.error('‚ùå Error calling loadCalendarData:', error);
                                    document.getElementById('errorMessage').textContent = `Failed to load calendar data: ${error.message}`;
                                    document.getElementById('loadingSection').classList.add('hidden');
                                    document.getElementById('errorSection').classList.remove('hidden');
                                }
                            } else if (attempts < maxAttempts) {
                                const nextAttempt = attempts + 1;
                                const waitTime = 500;
                                console.log(`‚è≥ loadCalendarData not ready yet, retrying in ${waitTime}ms... (${nextAttempt}/${maxAttempts})`);
                                updateLoadingMessage('Loading calendar data...', `Waiting for app.js... (${nextAttempt}/${maxAttempts})`);
                                setTimeout(() => tryLoadCalendarData(nextAttempt, maxAttempts), waitTime);
                            } else {
                                console.error('‚ùå Failed to load app.js after', maxAttempts, 'attempts');
                                document.getElementById('errorMessage').textContent = 'Failed to load app.js. Please refresh the page.';
                                document.getElementById('loadingSection').classList.add('hidden');
                                document.getElementById('errorSection').classList.remove('hidden');
                            }
                        };
                        
                        tryLoadCalendarData();
                    }
                },
            });
            
            console.log('üé® Rendering sign-in button...');
            
            // Create a custom button (Google's renderButton only works with ID tokens)
            const buttonDiv = document.getElementById("buttonDiv");
            buttonDiv.innerHTML = `
                <button id="customGoogleBtn" style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 12px;
                    background: white;
                    border: 1px solid #dadce0;
                    border-radius: 4px;
                    padding: 10px 12px;
                    font-family: 'Google Sans', Roboto, Arial, sans-serif;
                    font-size: 14px;
                    font-weight: 500;
                    color: #3c4043;
                    cursor: pointer;
                    transition: background-color 0.3s, box-shadow 0.3s;
                    min-width: 17vw;
                " onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.boxShadow='0 1px 2px 0 rgba(60,64,67,.30), 0 1px 3px 1px rgba(60,64,67,.15)';" 
                   onmouseout="this.style.backgroundColor='white'; this.style.boxShadow='none';">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                        <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2.01a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                        <path fill="#FBBC05" d="M4.5 10.52A4.8 4.8 0 0 1 4.5 7.48V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>
                        <path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/>
                    </svg>
                    Sign in with Google
                </button>
            `;
            
            document.getElementById("customGoogleBtn").addEventListener('click', () => {
                console.log('üñ±Ô∏è Sign-in button clicked - requesting access token...');
                // Request an access token
                tokenClient.requestAccessToken({prompt: ''});
            });
            
            console.log('‚úÖ Sign-in button rendered successfully');
            
            // Check if we already have a token
            const storedToken = localStorage.getItem('googleToken');
            if (storedToken && storedToken.length < 500) { // Access tokens are shorter than JWTs
                console.log('‚ôªÔ∏è Found stored access token, attempting to use it...');
                window.accessToken = storedToken;
                window.globalAccessToken = storedToken;
                
                // Try loading data
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('loadingSection').classList.remove('hidden');
                updateLoadingMessage('Using stored credentials...', 'Initializing...');
                
                // Use the same retry logic
                const tryLoadCalendarData = (attempts = 0, maxAttempts = 10) => {
                    console.log(`üîÑ Attempt ${attempts + 1}/${maxAttempts} to load calendar data...`);
                    
                    if (window.loadCalendarData && typeof window.loadCalendarData === 'function') {
                        console.log('‚úÖ Found loadCalendarData function, calling it...');
                        updateLoadingMessage('Loading calendar data...', 'Fetching events from Google Calendar...');
                        try {
                            window.loadCalendarData();
                        } catch (error) {
                            console.error('‚ùå Error calling loadCalendarData:', error);
                            document.getElementById('errorMessage').textContent = `Failed to load calendar data: ${error.message}`;
                            document.getElementById('loadingSection').classList.add('hidden');
                            document.getElementById('errorSection').classList.remove('hidden');
                        }
                    } else if (attempts < maxAttempts) {
                        const nextAttempt = attempts + 1;
                        const waitTime = 500;
                        console.log(`‚è≥ loadCalendarData not ready yet, retrying in ${waitTime}ms... (${nextAttempt}/${maxAttempts})`);
                        updateLoadingMessage('Loading calendar data...', `Waiting for app.js... (${nextAttempt}/${maxAttempts})`);
                        setTimeout(() => tryLoadCalendarData(nextAttempt, maxAttempts), waitTime);
                    } else {
                        console.error('‚ùå Failed to load app.js after', maxAttempts, 'attempts');
                        document.getElementById('errorMessage').textContent = 'Failed to load app.js. Please refresh the page.';
                        document.getElementById('loadingSection').classList.add('hidden');
                        document.getElementById('errorSection').classList.remove('hidden');
                    }
                };
                
                tryLoadCalendarData();
            }
        }
        
        // Start initialization when page loads
        window.onload = initializeGoogleAuth;
        
        // Also try when DOM is ready (backup)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGoogleAuth);
        } else {
            initializeGoogleAuth();
        }
    </script>
    
    <!-- Load mobile app.js first -->
    <script src="mobile-app.js"></script>
    <!-- Load app.js WITHOUT defer so it's available when we need it -->
    <!-- Cache busting: add timestamp to force reload -->
    <script src="app.js?v=20250117-1610"></script>
</body>
</html>
