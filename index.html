<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diary Analyzer - Web Application</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <h1>üìä Diary Analyzer</h1>
                <p class="header-subtitle">Beautiful time series visualization for your Google Calendar diary entries</p>
                <div class="controls">
                    <select id="dateRange" class="date-selector">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                    </select>
                    <select id="viewMode" class="view-selector">
                        <option value="distribution">Distribution</option>
                        <option value="timeline">Timeline</option>
                        <option value="advanced">Advanced Analytics</option>
                    </select>
                    <button id="refreshBtn" class="refresh-btn">üîÑ Refresh</button>
                </div>
            </div>
        </header>
        <main class="app-main">
            <div id="authSection" class="auth-section">
                <div class="auth-content">
                    <div class="auth-icon">üîê</div>
                    <h2>Connect to Google Calendar</h2>
                    <p>Sign in with your Google account to view and analyze your calendar diary entries</p>
                    <div id="g_id_onload"
                         data-client_id="1025050561840-jedvsb3bce3gjvj5k081l5afia5h0mnq.apps.googleusercontent.com"
                         data-context="signin"
                         data-ux_mode="popup"
                         data-callback="handleCredentialResponse"
                         data-auto_prompt="false">
                    </div>
                    <div class="g_id_signin"
                         data-type="standard"
                         data-shape="rectangular"
                         data-theme="outline"
                         data-text="signin_with"
                         data-size="large"
                         data-logo_alignment="left">
                    </div>
                    <p class="auth-note">We only request read-only access to your calendar data</p>
                </div>
            </div>
            <div id="loadingSection" class="loading-section hidden">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <h3>Loading your diary...</h3>
                    <p>Fetching calendar data and preparing visualizations</p>
                </div>
            </div>
            <div id="contentSection" class="content-section hidden">
                <div class="date-navigation">
                    <button id="prevDay" class="nav-btn">‚Äπ Previous</button>
                    <span id="currentDate" class="current-date"></span>
                    <button id="nextDay" class="nav-btn">Next ‚Ä∫</button>
                </div>
                <div id="timelineContainer" class="timeline-container">
                    <div id="timeline" class="timeline"></div>
                </div>
                <div id="distributionContainer" class="distribution-container hidden">
                    <div class="distribution-header">
                        <h2>Time Distribution by Calendar</h2>
                        <p class="distribution-subtitle">How you spent your time today</p>
                    </div>
                    <div id="distributionChart" class="distribution-chart"></div>
                    <div id="distributionStats" class="distribution-stats"></div>
                </div>
                <div id="advancedContainer" class="advanced-container hidden">
                    <div class="advanced-header">
                        <h2>Advanced Analytics</h2>
                        <div class="chart-mode-selector">
                            <label for="chartMode">View:</label>
                            <select id="chartMode" class="chart-mode-dropdown">
                                <option value="daily-totals">Daily Totals</option>
                                <option value="timeline-flow">Timeline Flow</option>
                            </select>
                        </div>
                        <div class="stacked-chart-selector">
                            <input type="checkbox" id="stackedChart" name="stackedChart" checked>
                            <label for="stackedChart" class="stacked-chart-label">Stacked</label>
                        </div>
                    </div>
                    <div id="advancedCharts" class="advanced-charts">
                        <canvas id="timeSeriesChart"></canvas>
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                <div class="stats-container">
                    <div class="stat-card">
                        <span class="stat-label">Total Events</span>
                        <span id="totalEvents" class="stat-value">0</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Active Hours</span>
                        <span id="activeHours" class="stat-value">0h</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Most Common</span>
                        <span id="mostCommon" class="stat-value">-</span>
                    </div>
                </div>
            </div>
            <div id="errorSection" class="error-section hidden">
                <div class="error-content">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <h2>Something went wrong</h2>
                    <p id="errorMessage">An error occurred while processing your request</p>
                    <button id="retryBtn" class="retry-btn">Try Again</button>
                </div>
            </div>
        </main>
        <footer class="app-footer">
            ¬© 2024 Diary Analyzer. Made with ‚ù§Ô∏è for productivity enthusiasts.
        </footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="config.js"></script>
    
    <!-- Google Sign-In callback function - must be available immediately -->
    <script>
        // Global callback function for Google Sign-In
        window.handleCredentialResponse = function(response) {
            console.log('üîê Google Sign-In response received!');
            console.log('üìã Response type:', typeof response);
            console.log('üìã Response keys:', response ? Object.keys(response) : 'null');
            console.log('üìã Full response:', response);
            
            if (response && response.credential) {
                console.log('‚úÖ Credential found in response');
                const token = response.credential;
                console.log('üîë Token length:', token.length);
                console.log('üîë Token preview:', token.substring(0, 50) + '...');
                
                // Store token in localStorage
                localStorage.setItem('googleToken', token);
                console.log('üíæ Token stored in localStorage');
                
                // Set global access token for app.js to use
                window.accessToken = token;
                window.globalAccessToken = token;
                
                console.log('‚úÖ Authentication successful - transitioning to loading...');
                
                // Show loading section
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('loadingSection').classList.remove('hidden');
                
                // Load calendar data
                if (window.loadCalendarData && typeof window.loadCalendarData === 'function') {
                    console.log('üìÖ Starting to load calendar data...');
                    window.loadCalendarData();
                } else {
                    console.log('üìÖ loadCalendarData not available yet, will be called when app.js loads');
                    // Set a flag that we need to load data
                    window.authCompleted = true;
                }
            } else {
                console.error('‚ùå Authentication failed - no credential in response');
                console.error('üîç Response structure:', response);
                
                // Show error
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('errorSection').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = 'Authentication failed. Please try again.';
            }
        };
        
        console.log('‚úÖ Google Sign-In callback function registered globally');
    </script>
    
    <script defer src="app.js"></script>
</body>
</html>
